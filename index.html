<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weed Detection Design Simulator - CAE Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;700;900&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f1f5f9; color: #0f172a; overflow-x: hidden; }
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        .blueprint-frame {
            border: 3px solid #1e293b;
            position: relative;
            background: #fff;
            border-radius: 4px;
        }

        .title-block {
            border-top: 3px solid #1e293b;
            background: #fff;
        }

        .section-header {
            background: #1e293b;
            color: white;
            padding: 6px 14px;
            font-size: 0.7rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.15em;
        }

        input[type="range"] {
            accent-color: #2563eb;
            height: 6px;
            cursor: pointer;
        }

        #three-container {
            width: 100%;
            height: 520px;
            background: radial-gradient(circle, #f8fafc 0%, #cbd5e1 100%);
            cursor: move;
            position: relative;
        }

        .formula-card {
            background: #0f172a;
            color: #94a3b8;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.65rem;
            border-left: 3px solid #3b82f6;
            margin-top: 4px;
        }

        .feasibility-ribbon {
            transform: rotate(45deg);
            position: absolute;
            top: 22px;
            right: -35px;
            width: 160px;
            text-align: center;
            font-weight: 900;
            font-size: 0.65rem;
            padding: 5px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .cae-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px;
            border: 1px solid #1e293b;
            border-radius: 4px;
            font-size: 0.65rem;
            display: none;
            width: 120px;
        }

        .legend-bar {
            width: 100%;
            height: 12px;
            background: linear-gradient(to right, #2563eb, #00ffff, #00ff00, #ffff00, #ff0000);
            border: 1px solid #000;
        }
    </style>
</head>
<body class="p-2 md:p-6">

    <div class="max-w-7xl mx-auto blueprint-frame shadow-2xl overflow-hidden bg-white">
        
        <!-- Technical Title Block -->
        <div class="grid grid-cols-1 md:grid-cols-12 title-block">
            <div class="md:col-span-4 p-6 flex items-center border-b md:border-b-0 md:border-r-2 border-slate-900">
                <div class="space-y-1">
                    <h1 class="text-xl font-black leading-none uppercase tracking-tighter">Weed Detection design simulator</h1>
                    <p class="text-[9px] font-bold text-slate-500 uppercase">Mechanical Engineering Department Project</p>
                </div>
            </div>
            <div class="md:col-span-3 p-4 text-[10px] space-y-1 mono border-b md:border-b-0 md:border-r-2 border-slate-900">
                <div class="flex justify-between"><span>Drawn By:</span> <b>vaibhav prasad</b></div>
                <div class="flex justify-between"><span>College:</span> <b>D Y Patil College of Engineering</b></div>
                <div class="flex justify-between"><span>Branch:</span> <b>Mechanical Department</b></div>
            </div>
            <div class="md:col-span-3 p-4 text-[10px] space-y-1 mono border-b md:border-b-0 md:border-r-2 border-slate-900">
                <div class="flex justify-between"><span>Material:</span> <b>AL-6061-T6 2040</b></div>
                <div class="flex justify-between"><span>Solver:</span> <b>Dynamic P-Vector CAE</b></div>
                <div class="flex justify-between"><span>Offsets:</span> <b id="offsetReadout">0, 0</b> mm</div>
            </div>
            <div class="md:col-span-2 p-4 flex flex-col justify-center items-center bg-slate-50 relative overflow-hidden">
                <div id="feasibilityRibbon" class="feasibility-ribbon bg-green-500 text-white">OPTIMIZED</div>
                <span class="text-[0.6rem] font-bold uppercase text-slate-400">Peak Stress</span>
                <span id="peakStressVal" class="text-2xl font-black text-slate-900">--</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 border-t-2 border-slate-900">
            
            <!-- Controls Sidebar -->
            <div class="lg:col-span-4 border-r-2 border-slate-900 bg-white">
                
                <div class="section-header">Physical Configuration</div>
                <div class="p-5 space-y-4 border-b border-slate-100">
                    <div>
                        <div class="flex justify-between text-[11px] font-black mb-1 uppercase text-slate-600">
                            <label>Frame Length (L)</label>
                            <span id="lVal" class="text-blue-600 mono">1100mm</span>
                        </div>
                        <input type="range" id="lIn" min="800" max="2500" value="1100" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-black mb-1 uppercase text-slate-600">
                            <label>Track Width (W)</label>
                            <span id="wVal" class="text-blue-600 mono">700mm</span>
                        </div>
                        <input type="range" id="wIn" min="500" max="1500" value="700" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-black mb-1 uppercase text-slate-600">
                            <label>Wheel Radius (R)</label>
                            <span id="rVal" class="text-blue-600 mono">250mm</span>
                        </div>
                        <input type="range" id="rIn" min="150" max="500" value="250" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-black mb-1 uppercase text-slate-600">
                            <label>Height Offset (O)</label>
                            <span id="hoVal" class="text-blue-600 mono">0mm</span>
                        </div>
                        <input type="range" id="hoIn" min="-100" max="400" value="0" class="w-full">
                    </div>
                </div>

                <div class="section-header">Load Point & Payload</div>
                <div class="p-5 space-y-4 bg-slate-50/50 border-b border-slate-100">
                    <div>
                        <div class="flex justify-between text-[11px] font-black mb-1 uppercase text-slate-600">
                            <label>Payload Mass</label>
                            <span id="mVal" class="text-blue-600 mono">50kg</span>
                        </div>
                        <input type="range" id="mIn" min="0" max="500" value="50" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-black mb-1 uppercase text-slate-600">
                            <label>Load X-Offset</label>
                            <span id="lxVal" class="text-blue-600 mono">0mm</span>
                        </div>
                        <input type="range" id="lxIn" min="-300" max="300" value="0" class="w-full">
                    </div>
                    <div>
                        <div class="flex justify-between text-[11px] font-black mb-1 uppercase text-slate-600">
                            <label>Load Z-Offset</label>
                            <span id="lzVal" class="text-blue-600 mono">0mm</span>
                        </div>
                        <input type="range" id="lzIn" min="-400" max="400" value="0" class="w-full">
                    </div>
                </div>

                <div class="section-header">CAE Structural Analytics</div>
                <div class="p-5 space-y-4 bg-slate-50 border-t border-slate-200">
                    <div class="space-y-1">
                        <div class="flex justify-between text-[10px] font-black uppercase text-slate-500">
                            <span>Max Bending Stress (&sigma;)</span>
                            <span id="stressDisplay" class="text-blue-600 font-bold">-- MPa</span>
                        </div>
                        <div class="formula-card mono">&sigma; = (M_offset * c) / I</div>
                    </div>
                    <div class="space-y-1">
                        <div class="flex justify-between text-[10px] font-black uppercase text-slate-500">
                            <span>Stability Index</span>
                            <span id="stabilityDisplay" class="text-green-600 font-bold">--</span>
                        </div>
                        <div class="formula-card mono">CoG_h = R + O + Lever_y</div>
                    </div>
                </div>

                <div class="p-5">
                    <label class="flex items-center gap-3 p-3 bg-blue-50 border border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition-all">
                        <input type="checkbox" id="enableCAE" class="w-5 h-5 accent-blue-600">
                        <span class="text-xs font-black text-blue-700 uppercase tracking-tight">Enable Structural CAE Mode</span>
                    </label>
                </div>
            </div>

            <!-- Visualization Area -->
            <div class="lg:col-span-8 bg-white flex flex-col relative">
                <div id="three-container">
                    <!-- Legend -->
                    <div id="caeLegend" class="cae-legend z-20 shadow-lg">
                        <div class="font-bold mb-1 border-b pb-1 text-center text-[10px]">Stress (MPa)</div>
                        <div class="legend-bar mb-1"></div>
                        <div class="flex justify-between mono">
                            <span>0</span>
                            <span id="maxLegendVal">240</span>
                        </div>
                    </div>
                    
                    <div class="absolute bottom-4 left-6 pointer-events-none text-[9px] font-black text-slate-400 uppercase tracking-widest">
                        Rotate: Drag Mouse | Zoom: Scroll | Analysis: Responsive
                    </div>

                    <!-- Module Toggles -->
                    <div class="absolute top-6 right-6 flex flex-col gap-2 z-20">
                        <label class="flex items-center gap-2 bg-white/90 px-3 py-1.5 rounded shadow border text-[9px] font-black cursor-pointer hover:bg-white transition-colors">
                            <input type="checkbox" id="tDrill" checked> ACTUATOR
                        </label>
                        <label class="flex items-center gap-2 bg-white/90 px-3 py-1.5 rounded shadow border text-[9px] font-black cursor-pointer hover:bg-white transition-colors">
                            <input type="checkbox" id="tPhone" checked> SENSOR MAST
                        </label>
                    </div>
                </div>

                <!-- Footer Summary -->
                <div class="mt-auto grid grid-cols-1 md:grid-cols-2 border-t-2 border-slate-900 divide-x-2 divide-slate-900 bg-white">
                    <div class="p-4">
                        <h3 class="text-[10px] font-black uppercase mb-2 text-slate-400">Mechanical Configuration</h3>
                        <div class="text-[11px] mono space-y-1 text-slate-700">
                            <div>• <span class="text-blue-600 font-bold">Chassis:</span> Reinforced T-Slot Aluminum</div>
                            <div>• <span class="text-black font-bold">Transmission:</span> 60mm Dynamic Slant Axles</div>
                            <div>• <span class="text-orange-600 font-bold">Analysis:</span> Real-Time FEA Proxy Solver</div>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50">
                        <h3 class="text-[10px] font-black uppercase mb-2 text-slate-400">Simulation Status</h3>
                        <div id="caeStatusText" class="text-[11px] font-bold text-slate-500 uppercase italic">
                            Engine online. All 3D meshes rendered.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CORE PARAMETERS ---
        const AL_YOUNGS_MODULUS = 69000; // MPa
        const AL_YIELD_STRENGTH = 240; // MPa
        const PROFILE_I = 48000; // Area Moment of Inertia mm^4
        const PROFILE_C = 20; // Fiber distance mm

        let scene, camera, renderer, machine;
        let cLong1, cLong2, cLongCenter, cCrossF, cCrossR, cCrossM;
        let wheels = [], shaftMeshes = [], motorBoxes = [], forceArrows = [];
        let pStand, drill;
        
        let isDragging = false;
        let prevMouse = { x: 0, y: 0 };

        function init() {
            const container = document.getElementById('three-container');
            const w = container.clientWidth;
            const h = container.clientHeight;

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf1f5f9);

            camera = new THREE.PerspectiveCamera(38, w / h, 1, 100000);
            camera.position.set(2200, 1200, 2200);
            camera.lookAt(0, 300, 0);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(w, h);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(renderer.domElement);

            scene.add(new THREE.AmbientLight(0xffffff, 0.7));
            const sun = new THREE.DirectionalLight(0xffffff, 1.0);
            sun.position.set(1000, 2000, 1000);
            sun.castShadow = true;
            sun.shadow.mapSize.width = 2048;
            scene.add(sun);

            scene.add(new THREE.GridHelper(5000, 50, 0x94a3b8, 0xe2e8f0));

            machine = new THREE.Group();
            scene.add(machine);

            // Frame Rail Subdivided Geometry
            const railGeo = new THREE.BoxGeometry(1, 1, 1, 1, 1, 60); 
            const blueMat = new THREE.MeshStandardMaterial({ color: 0x2563eb, metalness: 0.6, roughness: 0.3 });
            
            cLong1 = new THREE.Mesh(railGeo.clone(), blueMat.clone());
            cLong2 = new THREE.Mesh(railGeo.clone(), blueMat.clone());
            cLongCenter = new THREE.Mesh(railGeo.clone(), blueMat.clone());
            cCrossF = new THREE.Mesh(railGeo.clone(), blueMat.clone());
            cCrossR = new THREE.Mesh(railGeo.clone(), blueMat.clone());
            cCrossM = new THREE.Mesh(railGeo.clone(), blueMat.clone());
            
            [cLong1, cLong2, cLongCenter, cCrossF, cCrossR, cCrossM].forEach(m => {
                m.castShadow = true;
                m.receiveShadow = true;
                machine.add(m);
            });

            const blackMat = new THREE.MeshStandardMaterial({ color: 0x1e293b, roughness: 1 });
            const alumMat = new THREE.MeshStandardMaterial({ color: 0x94a3b8, metalness: 0.9 });
            const motorMat = new THREE.MeshStandardMaterial({ color: 0x334155, metalness: 0.7 });

            for(let i=0; i<4; i++) {
                // Wheel Assembly
                const wheelGroup = new THREE.Group();
                const tire = new THREE.Mesh(new THREE.CylinderGeometry(1, 1, 1, 64), blackMat);
                tire.rotation.z = Math.PI/2;
                wheelGroup.add(tire);
                
                // Agriculture Spokes
                for(let j=0; j<8; j++) {
                    const spoke = new THREE.Mesh(new THREE.BoxGeometry(1.95, 0.05, 0.05), blackMat);
                    spoke.rotation.x = (j/8) * Math.PI;
                    wheelGroup.add(spoke);
                }
                wheels.push(wheelGroup);
                machine.add(wheelGroup);

                // Axle Rod (Reduced to 60mm later)
                const axle = new THREE.Mesh(new THREE.CylinderGeometry(12, 12, 1, 16), alumMat);
                axle.rotation.z = Math.PI/2;
                shaftMeshes.push(axle);
                machine.add(axle);

                // Motor Case
                const mBox = new THREE.Mesh(new THREE.BoxGeometry(100, 100, 100), motorMat);
                motorBoxes.push(mBox);
                machine.add(mBox);
            }

            pStand = new THREE.Mesh(new THREE.BoxGeometry(25, 600, 25), alumMat);
            machine.add(pStand);

            drill = new THREE.Group();
            const dBody = new THREE.Mesh(new THREE.CylinderGeometry(40, 40, 120, 16), motorMat);
            const dBit = new THREE.Mesh(new THREE.CylinderGeometry(5, 40, 150, 16), new THREE.MeshStandardMaterial({color: 0xf59e0b}));
            dBit.position.y = -80;
            drill.add(dBody, dBit);
            machine.add(drill);

            const arrowGeo = new THREE.ConeGeometry(40, 150, 8);
            const arr = new THREE.Mesh(arrowGeo, new THREE.MeshBasicMaterial({color: 0xffaa00}));
            arr.visible = false;
            forceArrows.push(arr);
            machine.add(arr);

            container.addEventListener('mousedown', e => { isDragging = true; prevMouse = { x: e.offsetX, y: e.offsetY }; });
            window.addEventListener('mouseup', () => isDragging = false);
            container.addEventListener('mousemove', e => {
                if(isDragging) {
                    machine.rotation.y += (e.offsetX - prevMouse.x) * 0.01;
                    machine.rotation.x = Math.max(-0.8, Math.min(0.8, machine.rotation.x + (e.offsetY - prevMouse.y) * 0.01));
                }
                prevMouse = { x: e.offsetX, y: e.offsetY };
            });
            container.addEventListener('wheel', e => { 
                e.preventDefault(); 
                camera.position.multiplyScalar(e.deltaY > 0 ? 1.05 : 0.95); 
            }, { passive: false });

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }

        function getColorFromStress(val, max) {
            if (max === 0) return new THREE.Color(0x2563eb);
            const ratio = Math.min(val / max, 1);
            const color = new THREE.Color(0x2563eb);
            if (ratio < 0.2) color.lerp(new THREE.Color(0x00ffff), ratio * 5);
            else if (ratio < 0.4) color.set(0x00ffff).lerp(new THREE.Color(0x00ff00), (ratio - 0.2) * 5);
            else if (ratio < 0.6) color.set(0x00ff00).lerp(new THREE.Color(0xffff00), (ratio - 0.4) * 5);
            else if (ratio < 0.8) color.set(0xffff00).lerp(new THREE.Color(0xff7700), (ratio - 0.6) * 5);
            else color.set(0xff7700).lerp(new THREE.Color(0xff0000), (ratio - 0.8) * 5);
            return color;
        }

        function updateAnalysis() {
            const L = parseInt(document.getElementById('lIn').value);
            const W = parseInt(document.getElementById('wIn').value);
            const R = parseInt(document.getElementById('rIn').value);
            const Offset = parseInt(document.getElementById('hoIn').value);
            const M_kg = parseInt(document.getElementById('mIn').value);
            const offX = parseInt(document.getElementById('lxIn').value);
            const offZ = parseInt(document.getElementById('lzIn').value);
            const caeActive = document.getElementById('enableCAE').checked;

            document.getElementById('lVal').innerText = L + "mm";
            document.getElementById('wVal').innerText = W + "mm";
            document.getElementById('rVal').innerText = R + "mm";
            document.getElementById('hoVal').innerText = Offset + "mm";
            document.getElementById('mVal').innerText = M_kg + "kg";
            document.getElementById('lxVal').innerText = offX + "mm";
            document.getElementById('lzVal').innerText = offZ + "mm";
            document.getElementById('offsetReadout').innerText = `${offX}, ${offZ}`;

            // --- CAE CALCULATIONS ---
            const ForceTotal = (25 + M_kg) * 9.81;
            const a = L/2 + offZ;
            const b = L/2 - offZ;
            // Simplified Bending Moment for Off-Center Load
            const maxMoment = (ForceTotal * (a/1000) * (b/1000)) / Math.max(0.1, L/1000);
            const stressMPa = (maxMoment * 1000 * PROFILE_C) / PROFILE_I;
            const cogHeight = R + Offset + 50; 
            const stability = (W/2) / Math.max(1, cogHeight);

            document.getElementById('stressDisplay').innerText = stressMPa.toFixed(2) + " MPa";
            document.getElementById('stabilityDisplay').innerText = stability.toFixed(2);
            document.getElementById('peakStressVal').innerText = stressMPa.toFixed(1) + " MPa";
            document.getElementById('caeLegend').style.display = caeActive ? 'block' : 'none';
            
            const rib = document.getElementById('feasibilityRibbon');
            if(stressMPa > AL_YIELD_STRENGTH || stability < 0.6) {
                rib.innerText = stability < 0.6 ? "TIPPING RISK" : "YIELD FAILURE";
                rib.className = "feasibility-ribbon bg-red-600 text-white";
            } else if (stressMPa > 150) {
                rib.innerText = "CAUTION";
                rib.className = "feasibility-ribbon bg-amber-500 text-white";
            } else {
                rib.innerText = "OPTIMIZED";
                rib.className = "feasibility-ribbon bg-green-500 text-white";
            }

            drawMachine(L, W, R, Offset, stressMPa, caeActive, offX, offZ);
        }

        function drawMachine(L, W, R, Offset, stress, caeActive, offX, offZ) {
            if(!machine) return;
            const prof = 40; 
            const h_axle = R;
            const h_chassis = R + Offset;

            [cLong1, cLong2, cLongCenter].forEach((m, idx) => {
                const railX = idx === 0 ? -W/2 : (idx === 1 ? W/2 : 0);
                m.scale.set(prof, prof, L);
                m.position.set(railX, h_chassis, 0);
                
                if(caeActive) {
                    m.material = new THREE.MeshBasicMaterial({vertexColors: true});
                    const positions = m.geometry.attributes.position;
                    const colors = [];
                    const xFactor = Math.max(0.2, 1 - (Math.abs(railX - offX) / (W/2)));

                    for(let i=0; i<positions.count; i++) {
                        const zLocal = positions.getZ(i);
                        const worldZ = zLocal * L;
                        let zFactor = 0;
                        if (worldZ <= offZ) zFactor = (worldZ + L/2) / Math.max(1, offZ + L/2);
                        else zFactor = (L/2 - worldZ) / Math.max(1, L/2 - offZ);
                        
                        const localStress = stress * Math.max(0, zFactor) * xFactor;
                        const c = getColorFromStress(localStress, stress);
                        colors.push(c.r, c.g, c.b);
                    }
                    m.geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
                    m.geometry.attributes.color.needsUpdate = true;
                } else {
                    m.material = new THREE.MeshStandardMaterial({color: 0x2563eb, metalness: 0.6});
                    if(m.geometry.attributes.color) m.geometry.deleteAttribute('color');
                }
            });

            cCrossF.scale.set(W, prof, prof); cCrossF.position.set(0, h_chassis, -L/2 + prof/2);
            cCrossR.scale.set(W, prof, prof); cCrossR.position.set(0, h_chassis, L/2 - prof/2);
            cCrossM.scale.set(W, prof, prof); cCrossM.position.set(0, h_chassis, 0);

            const shaftLen = 60;
            const tireWidth = 80;
            const wheelX = W/2 + shaftLen; 
            const wheelZ = [-L/2 + 200, -L/2 + 200, L/2 - 200, L/2 - 200];
            
            wheels.forEach((w, i) => {
                w.scale.set(tireWidth, R, R);
                w.position.set(i % 2 === 0 ? -wheelX : wheelX, h_axle, wheelZ[i]);
            });

            shaftMeshes.forEach((axle, i) => {
                axle.scale.set(1, shaftLen, 1); 
                const rX = i % 2 === 0 ? -(W/2 + shaftLen/2) : (W/2 + shaftLen/2);
                axle.position.set(rX, (h_chassis + h_axle)/2, wheelZ[i]);
                
                axle.rotation.set(0, 0, 0); 
                axle.rotation.z = Math.PI/2;
                const angle = Math.atan2(Offset, shaftLen);
                axle.rotation.y = i % 2 === 0 ? angle : -angle;
            });

            motorBoxes.forEach((mBox, i) => {
                mBox.position.set(i % 2 === 0 ? -W/2 : W/2, h_chassis, wheelZ[i]);
            });

            pStand.visible = document.getElementById('tPhone').checked;
            pStand.position.set(0, h_chassis + 300, -L/2 + 50);

            drill.visible = document.getElementById('tDrill').checked;
            drill.position.set(offX, h_chassis - 10, offZ);

            forceArrows.forEach((a) => {
                a.visible = caeActive;
                a.position.set(offX, h_chassis + 300, offZ);
                a.rotation.x = Math.PI;
            });
        }

        window.onload = () => {
            init();
            const controlIds = [
                'lIn', 'wIn', 'rIn', 'hoIn', 'mIn', 'lxIn', 'lzIn', 
                'enableCAE', 'tPhone', 'tDrill'
            ];
            controlIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateAnalysis);
            });
            updateAnalysis();
        };
    </script>
</body>
</html>
